import { Duration } from "luxon";
import useAudioRecorder from "@/hooks/useAudioRecorder";
import { AudioRecorderButton } from "@/components/audio-recorder-hook/audio-recorder-button";
import { AudioRecorderVisualizer } from "@/components/audio-recorder-hook/audio-recorder-visualizer";
import AppContainer from "@/components/app-container";
import Link from "next/link";

<AppContainer maxWidth="sm"><div className="docs-page">

üìì <Link href={"/docs"} as={"/docs"}>Back to Overview</Link>

-----

# üëÇ Recording Audio with React

WIP: should have some more texts, right now just code and demos.

## A React Hook abstracting away audio recording controls

```tsx
const {
    isListening,
    isRecording,
    isRequestingAccess,
    startListening,
    stopListening,
    startRecording,
    stopRecording,
    getFrequencyData,
    dataBlobs,
    dataSize,
    dataSeconds,
    clearData,
    error,
  } = useAudioRecorder();
```

## A React recorder button component mimicking iOS Voice Memos

```tsx
<AudioRecorderButton
    onStartRecording={startRecording}
    onStopRecording={stopRecording}
    isRecording={isRecording}
    isRequestingAccess={isRequestingAccess}
/>
```



export const AudioRecorderButtonWithState = () => {
    const {
    isRecording,
    isRequestingAccess,
    startRecording,
    stopRecording,
    dataBlobs,
    dataSeconds,
    clearData
  } = useAudioRecorder();
  return (
      <div style={{display: "flex", flexDirection:"column", alignItems: "center", padding: 16}}>
        <AudioRecorderButton
            onStartRecording={() => {clearData(); startRecording()}}
            onStopRecording={stopRecording}
            isRecording={isRecording}
            isRequestingAccess={isRequestingAccess}
        />
        <div style={{margin: 16}}>
            {Duration.fromObject({
                seconds: dataSeconds,
            }).toFormat("mm:ss")}
        </div>
        {dataBlobs.length === 0 && ( <p>Yes, you can press that button üëÜ</p>)}
        {dataBlobs.length === 1 && ( <audio src={URL.createObjectURL(dataBlobs[0])} controls></audio>)}
        {dataBlobs.length === 1 && ( <button onClick={clearData}>Clear recording</button>)}
    </div>
  )
}

<AudioRecorderButtonWithState />


## A React component for visualizing incoming recordings


```tsx
<AudioRecorderVisualizer
    uniqueId="demo"
    getFrequencyData={getFrequencyData}
/>
```


export const AudioRecorderVisualizerWithState = () => {
  const { getFrequencyData, startListening, stopListening, isListening } = useAudioRecorder();
  return (
    <div style={{display: "flex", flexDirection:"column", alignItems: "center", padding: 16}}> 
      { isListening && <>
        <AudioRecorderVisualizer
          uniqueId="demo"
          getFrequencyData={getFrequencyData}
        />
        <p>Make some noise now! üòÅ</p>
        </>
      }
    
      
    {isListening
        ? <button onClick={stopListening}>Stop listening and hide visualizer</button>
        : <button onClick={startListening}>Start listening and show visualizer</button>}
    </div>
  );
}

<AudioRecorderVisualizerWithState />

## Implementation details

### ‚ö†Ô∏è MediaRecorder required a polyfill

* The API of `window.MediaRecorder` is not implemented consistent accross browsers, so it's best to use the `audio-recorder-polyfill`.
* I't also smart to rely on a polyfilled MP3 encoder, this also eases uploading and listening back the recording afterwards.

```js
import AudioRecorder from "audio-recorder-polyfill";
import mpegEncoder from "audio-recorder-polyfill/mpeg-encoder";

AudioRecorder.encoder = mpegEncoder;
AudioRecorder.prototype.mimeType = "audio/mpeg";
window.MediaRecorder = AudioRecorder;
```

* **Next.js specific**: save the above polyfill declaration into a file, e.g. `./src/client-polyfills.js` and load it within the `next.config.js`:

```js
module.exports = {
  webpack: function (cfg) {
    const originalEntry = cfg.entry;
    cfg.entry = async () => {
      const entries = await originalEntry();
      // Add client polyfills
      if (
        entries["main.js"] &&
        !entries["main.js"].includes("./src/client-polyfills.js")
      ) {
        entries["main.js"].unshift("./src/client-polyfills.js");
      }

      return entries;
    };

    return cfg;
  },
};
```

### ‚ö†Ô∏è AudioContext required standardization

* AudioContext is also not consistently implemented, so `useAudioRecorder` uses `standardized-audio-context`.

```ts
import {
  AudioContext,
  IAudioContext,
  IMediaStreamAudioSourceNode,
} from "standardized-audio-context";
```

</div></AppContainer>